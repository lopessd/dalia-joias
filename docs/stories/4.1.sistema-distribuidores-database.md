# Story 4.1: Sistema de Distribuidores com Integração Database

**Data:** 1 de setembro de 2025  
**Status:** Draft  
**PO:** Sarah  
**Projeto:** Sistema Dalia Joias  

---

## Story

**As an** Admin User,  
**I want** to view and manage real distributor (reseller) data from the database including their profiles and authentication information,  
**so that** I can have accurate, up-to-date information about all resellers in the system and make informed business decisions based on real data.

---

## Acceptance Criteria

1. **AC1:** A página `/admin/revendedores` deve exibir dados reais de usuários com role "reseller" do banco de dados
2. **AC2:** Cada card de distribuidor deve mostrar informações do perfil (auth.users + public.profiles)  
3. **AC3:** A busca deve funcionar em tempo real nos campos nome/email dos distribuidores
4. **AC4:** As estatísticas do dashboard devem ser calculadas com dados reais do banco
5. **AC5:** O sistema deve manter a interface atual mas substituir completamente os dados mock
6. **AC6:** Deve haver tratamento de erros para problemas de conexão com banco
7. **AC7:** O carregamento deve mostrar skeleton/loading states apropriados

---

## Tasks / Subtasks

### **Task 1: Criar API para busca de distribuidores** (AC: 1,2,4)
- [ ] 1.1 Criar função `getResellers()` em `lib/users-api.ts`
  - Buscar dados de auth.users JOIN profiles WHERE role = 'reseller'
  - Incluir campos: id, email, created_at, role, address, description, active
- [ ] 1.2 Criar função `getResellerStats()` para estatísticas
  - Total de revendedores
  - Revendedores ativos (active = true)
  - Cálculos agregados necessários para dashboard
- [ ] 1.3 Adicionar tratamento de erro e tipos TypeScript

### **Task 2: Atualizar interface TypeScript** (AC: 2,5)  
- [ ] 2.1 Criar interface `ResellerProfile` em `lib/supabase.ts`
- [ ] 2.2 Atualizar props dos componentes para usar dados reais
- [ ] 2.3 Mapear campos do banco para estrutura esperada pelos componentes

### **Task 3: Modificar página de revendedores** (AC: 1,3,5,7)
- [ ] 3.1 Substituir `mockRevendedores` por chamada real da API
- [ ] 3.2 Implementar states de loading com skeleton
- [ ] 3.3 Manter funcionalidade de busca funcionando com dados reais
- [ ] 3.4 Adicionar tratamento de erro com fallback

### **Task 4: Atualizar componente RevendedorCard** (AC: 2,5)
- [ ] 4.1 Ajustar mapeamento de campos para dados reais
- [ ] 4.2 Tratar campos opcionais (address, description)  
- [ ] 4.3 Formatar datas corretamente
- [ ] 4.4 Manter funcionalidades de edição existentes

### **Task 5: Integrar com dashboard admin** (AC: 4)
- [ ] 5.1 Atualizar `app/admin/dashboard/page.tsx`
- [ ] 5.2 Usar dados reais para estatísticas de distribuidores
- [ ] 5.3 Manter formatação e UI existente

---

## Dev Notes

### **Estrutura do Banco de Dados (NÃO ALTERAR)**

```sql
-- Tabela auth.users (Supabase Auth)
id UUID PRIMARY KEY
email VARCHAR
created_at TIMESTAMP
-- outros campos de autenticação

-- Tabela public.profiles  
id UUID PRIMARY KEY REFERENCES auth.users(id)
role USER_ROLE ('admin' | 'reseller') 
address TEXT
description TEXT  
active BOOLEAN DEFAULT true
created_at TIMESTAMP
```

### **Consulta SQL Base**
```sql
SELECT 
  u.id,
  u.email,
  u.created_at as user_created_at,
  p.role,
  p.address,
  p.description,
  p.active,
  p.created_at as profile_created_at
FROM auth.users u
INNER JOIN public.profiles p ON u.id = p.id  
WHERE p.role = 'reseller'
ORDER BY u.created_at DESC
```

### **Arquivos a Modificar**

1. **`lib/users-api.ts`** (CRIAR)
   - Funções para buscar revendedores
   - Tratamento de erros
   - Tipos TypeScript

2. **`app/admin/revendedores/page.tsx`**
   - Substituir mock data por API calls
   - Implementar loading states
   - Manter UI existente

3. **`components/revendedores/revendedor-card.tsx`**
   - Ajustar mapeamento de campos
   - Tratar campos opcionais

4. **`lib/supabase.ts`** 
   - Adicionar interfaces TypeScript

5. **`app/admin/dashboard/page.tsx`**
   - Integrar estatísticas reais

### **Exemplo de Interface TypeScript**

```typescript
export interface ResellerProfile {
  id: string
  email: string
  user_created_at: string
  role: 'reseller'
  address: string | null
  description: string | null
  active: boolean
  profile_created_at: string
}

export interface ResellerStats {
  total_resellers: number
  active_resellers: number
  inactive_resellers: number
}
```

### **Exemplo de Função API**

```typescript
export async function getResellers(): Promise<ResellerProfile[]> {
  const { data, error } = await supabase
    .from('profiles')
    .select(`
      id,
      role,
      address,
      description,
      active,
      created_at,
      user:auth.users!inner(
        id,
        email,
        created_at
      )
    `)
    .eq('role', 'reseller')
    .order('created_at', { ascending: false })

  if (error) throw error
  
  return data?.map(profile => ({
    id: profile.id,
    email: profile.user.email,
    user_created_at: profile.user.created_at,
    role: profile.role as 'reseller',
    address: profile.address,
    description: profile.description,
    active: profile.active,
    profile_created_at: profile.created_at
  })) || []
}
```

---

## Testing

### **Cenários de Teste**

1. **Dados válidos:** Verificar exibição correta de revendedores  
2. **Busca:** Testar filtro por nome e email
3. **Estados vazios:** Comportamento quando não há distribuidores
4. **Erro de rede:** Fallback apropriado para falhas de API
5. **Loading:** Estados de carregamento funcionais
6. **Responsividade:** Interface mantém responsividade

### **Comandos de Teste**
```bash
# Testar conexão com banco
npm run test:db

# Testar componentes
npm test components/revendedores

# Verificar tipos
npm run type-check
```

---

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-09-01 | 1.0 | História inicial criada | Sarah (PO) |

---

## Notas Importantes

- **NÃO ALTERAR** estrutura do banco de dados
- **MANTER** interface visual existente
- **SUBSTITUIR COMPLETAMENTE** mock data por dados reais
- **USAR MCP Supabase** para testes durante desenvolvimento
- **TESTAR** com dados reais existentes no banco

---

**Prioridade:** Alta  
**Sprint:** Sprint atual  
**Estimate:** 8 story points
