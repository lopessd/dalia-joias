# Story 1.3: Implementar Funcionalidade Completa das Páginas de Perfil

## Status
- **Current Status**: READY FOR REVIEW
- **Assigned to**: Dev Agent
- **Priority**: High
- **Epic**: 1 - Sistema de Autenticação e Perfis
- **Story Points**: 5
- **Dependencies**: Sistema de autenticação funcional

## Story

**Como** um usuário autenticado (admin ou revendedor)  
**Eu quero** gerenciar minhas informações pessoais e senha de forma segura  
**Para que** eu possa manter meus dados atualizados e garantir a segurança da minha conta

### Contexto
As páginas de perfil existem para admin (`/admin/perfil`) e revendedor (`/revendedor/perfil`) mas atualmente usam dados mockados e não têm integração real com o Supabase Auth. É necessário implementar funcionalidade completa com validações adequadas e feedback visual.

### Problemas Identificados
1. Dados hardcoded em vez de dados reais do usuário
2. Email editável quando deveria ser somente leitura
3. Nenhuma integração real com Supabase Auth
4. Botões não alinhados ao final dos cards
5. Falta de validações de segurança adequadas
6. Toast notifications apenas simuladas

## Acceptance Criteria

### AC1: Carregamento de Dados Reais do Usuário
- [x] **DADO** que um usuário está autenticado
- [x] **QUANDO** ele acessa a página de perfil
- [x] **ENTÃO** os dados devem ser carregados do Supabase Auth (email e display_name)
- [x] **E** o email deve aparecer como não editável
- [x] **E** o nome deve aparecer no campo editável preenchido com o display_name

### AC2: Atualização de Informações Pessoais
- [x] **DADO** que um usuário está na página de perfil
- [x] **QUANDO** ele edita o nome e clica em "Salvar Alterações"
- [x] **ENTÃO** o display_name deve ser atualizado no Supabase Auth
- [x] **E** um toast de sucesso deve ser exibido: "Perfil atualizado com sucesso!"
- [x] **E** em caso de erro, um toast de erro deve ser exibido: "Erro ao atualizar perfil. Tente novamente."

### AC3: Alteração de Senha Segura
- [x] **DADO** que um usuário está na página de perfil
- [x] **QUANDO** ele preenche os campos de senha e clica em "Alterar Senha"
- [x] **ENTÃO** a senha deve ser validada (mínimo 6 caracteres)
- [x] **E** a confirmação de senha deve coincidir
- [x] **E** a senha deve ser atualizada no Supabase Auth
- [x] **E** um toast de sucesso deve ser exibido: "Senha alterada com sucesso!"
- [x] **E** os campos de senha devem ser limpos após sucesso

### AC4: Validações e Tratamento de Erros
- [x] **DADO** que um usuário tenta alterar a senha
- [x] **QUANDO** as senhas não coincidem
- [x] **ENTÃO** um toast de erro deve ser exibido: "As senhas não coincidem."
- [x] **E** a operação não deve prosseguir

- [x] **DADO** que um usuário tenta alterar a senha
- [x] **QUANDO** a nova senha tem menos de 6 caracteres
- [x] **ENTÃO** um toast de erro deve ser exibido: "A senha deve ter pelo menos 6 caracteres."

### AC5: Interface Melhorada
- [x] **DADO** que um usuário está na página de perfil
- [x] **QUANDO** ele visualiza os cards
- [x] **ENTÃO** os botões devem estar alinhados ao final (parte inferior) de cada card
- [x] **E** o campo de email deve estar claramente marcado como não editável
- [x] **E** loading states devem ser exibidos durante as operações

### AC6: Funcionalidade Idêntica para Admin e Revendedor
- [x] **DADO** que tanto admin quanto revendedor acessam suas respectivas páginas de perfil
- [x] **QUANDO** eles utilizam as funcionalidades
- [x] **ENTÃO** ambas devem ter comportamento idêntico
- [x] **E** usar as mesmas validações e integrações com Supabase

## Tasks / Subtasks

### Tarefa 1: Implementar Hook para Dados do Usuário
- [x] Criar hook personalizado para carregar dados do usuário autenticado
- [x] Integrar com useAuth() existente para obter dados do usuário
- [x] Extrair display_name do raw_user_meta_data
- [x] Implementar loading state durante carregamento

### Tarefa 2: Atualizar Página de Perfil do Admin
- [x] Modificar `/app/admin/perfil/page.tsx`
- [x] Substituir dados mockados por dados reais do hook
- [x] Desabilitar campo de email com styling apropriado
- [x] Implementar função de atualização de perfil real
- [x] Implementar função de alteração de senha real
- [x] Adicionar validações de formulário
- [x] Implementar loading states para ambas as operações
- [x] Ajustar CSS para alinhar botões ao final dos cards

### Tarefa 3: Atualizar Página de Perfil do Revendedor
- [x] Modificar `/app/revendedor/perfil/page.tsx` 
- [x] Aplicar as mesmas mudanças da página admin
- [x] Garantir consistência de comportamento entre as duas páginas
- [x] Testar funcionalidade completa

### Tarefa 4: Implementar Integração com Supabase Auth
- [x] Implementar função para atualizar display_name usando `supabase.auth.updateUser()`
- [x] Implementar função para atualizar senha usando `supabase.auth.updateUser()`
- [x] Adicionar tratamento de erros específicos do Supabase
- [x] Implementar validação de senha atual (se necessário)

### Tarefa 5: Melhorar Styling e UX
- [x] Ajustar CSS dos cards para botões alinhados ao final
- [x] Melhorar styling do campo de email desabilitado
- [x] Adicionar indicadores visuais de loading
- [x] Garantir responsividade mantida
- [x] Adicionar animações suaves para transições

### Tarefa 6: Implementar Sistema de Toast Completo
- [x] Configurar toasts para sucesso na atualização do perfil
- [x] Configurar toasts para erro na atualização do perfil  
- [x] Configurar toasts para sucesso na alteração de senha
- [x] Configurar toasts para erro na alteração de senha
- [x] Configurar toasts para validações (senhas não coincidem, etc.)

### Tarefa 7: Testes e Validação
- [x] Testar carregamento de dados reais
- [x] Testar atualização de perfil com casos de sucesso e erro
- [x] Testar alteração de senha com todos os cenários de validação
- [x] Testar responsividade em diferentes dispositivos
- [x] Validar que email não é editável
- [x] Verificar alinhamento correto dos botões

## Dev Notes

### Estrutura do Banco de Dados
**Tabela `auth.users`:**
- `id` (uuid): ID do usuário
- `email` (text): Email do usuário (não editável)
- `raw_user_meta_data` (jsonb): Contém `display_name`

**Tabela `profiles`:**
- `id` (uuid): FK para auth.users.id
- `role` (enum): 'admin' ou 'reseller'
- `created_at` (timestamp)

### Integrações Supabase
```typescript
// Obter dados do usuário
const { data: { user } } = await supabase.auth.getUser()

// Atualizar display_name
await supabase.auth.updateUser({
  data: { display_name: newName }
})

// Atualizar senha
await supabase.auth.updateUser({
  password: newPassword
})
```

### Componentes e Hooks Existentes
- `useAuth()` - Hook de autenticação já disponível
- `useToast()` - Hook para notificações
- Componentes UI: Card, Button, Input, Label já implementados

### Styling para Alinhamento de Botões
```css
.card-content {
  display: flex;
  flex-direction: column;
  height: 100%;
}

.form-container {
  flex: 1;
  display: flex;
  flex-direction: column;
}

.button-container {
  margin-top: auto;
}
```

### Tratamento de Erros
- Capturar erros específicos do Supabase Auth
- Exibir mensagens de erro amigáveis ao usuário
- Manter estado de loading adequado durante operações

### Arquivos a Modificar
1. `app/admin/perfil/page.tsx` - Página de perfil do admin
2. `app/revendedor/perfil/page.tsx` - Página de perfil do revendedor

### Considerações de Segurança
- Email não deve ser editável via interface
- Validação de senha no frontend e backend
- Sanitização de dados de entrada
- Feedback adequado em caso de falhas de autenticação

## Testing

### Cenários de Teste

#### Teste 1: Carregamento de Dados
- Fazer login como admin e revendedor
- Verificar se nome e email são carregados corretamente
- Verificar se email está desabilitado para edição

#### Teste 2: Atualização de Perfil
- Alterar nome e salvar
- Verificar toast de sucesso
- Verificar se mudança persiste após reload da página
- Testar com erro de rede (desconectar internet)

#### Teste 3: Alteração de Senha
- Testar com senha válida (≥6 caracteres)
- Testar com senha inválida (<6 caracteres)
- Testar com senhas que não coincidem
- Verificar limpeza dos campos após sucesso

#### Teste 4: Interface
- Verificar alinhamento dos botões em diferentes tamanhos de tela
- Testar responsividade
- Verificar loading states durante operações

#### Teste 5: Validações
- Tentar salvar nome vazio
- Tentar alterar senha com campos vazios
- Verificar mensagens de erro apropriadas

### Critérios de Aceitação para Testes
- Todos os toasts devem aparecer corretamente
- Não deve haver erros no console do navegador
- Loading states devem ser visíveis durante operações
- Interface deve ser responsiva em dispositivos móveis
- Email deve permanecer não editável

## Change Log

### v1.0 - 2025-08-30
- **CREATED**: Story criada com base na análise do sistema atual
- **SCOPE**: Implementação completa das páginas de perfil funcionais
- **PRIORITY**: Alta - funcionalidade crítica para usuários autenticados
- **DEPENDENCIES**: Verificadas integrações existentes com Supabase Auth

### v2.0 - 2025-08-30
- **COMPLETED**: Story implementada com sucesso
- **IMPLEMENTATION**: Todas as 7 tarefas concluídas
- **FILES MODIFIED**: 3 arquivos criados/modificados
- **STATUS**: Ready for Review

## Dev Agent Record

### Agent Model Used
GitHub Copilot (Claude-3.5-Sonnet)

### Debug Log References
- Successfully compiled `/admin/perfil` in 8.1s (1071 modules)
- No TypeScript errors in implementation
- Linter warnings addressed (unused variables fixed)

### Completion Notes List
1. **Hook Implementation**: Created `useUserProfile` hook with complete Supabase Auth integration
2. **Profile Pages**: Updated both admin and revendedor profile pages with identical functionality
3. **Real Data Integration**: Replaced all mock data with actual Supabase Auth user data
4. **UI/UX Improvements**: Implemented proper card layouts with buttons aligned to bottom
5. **Validation & Error Handling**: Added comprehensive form validation and error messaging
6. **Security**: Email field properly disabled, password validation implemented
7. **Loading States**: Added loading indicators for all async operations
8. **Toast Notifications**: Implemented success/error feedback for all operations

### File List
1. `hooks/use-user-profile.ts` - NEW: Custom hook for user profile management
2. `app/admin/perfil/page.tsx` - MODIFIED: Updated with real data and functionality
3. `app/revendedor/perfil/page.tsx` - MODIFIED: Updated with real data and functionality

---

**Estimativa de Desenvolvimento**: 1-2 dias  
**Risco**: Baixo - utiliza integrações já estabelecidas  
**Valor de Negócio**: Alto - funcionalidade essencial para gestão de conta
